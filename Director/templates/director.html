<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Render Farm Director</title>
    <link rel="stylesheet" href="/static/director_style.css">
</head>
<body>
    <div class="main-container">
        <h1>Render Farm Director</h1>

        <div class="panel" id="control-panel">
            <h2>Director Control Panel</h2>
            <div class="control-sections">
                <div class="control-section">
                    <h3>AGENT MANAGEMENT</h3>
                    <div class="form-group">
                        <label for="agent-ip">Agent IP:Port</label>
                        <input type="text" id="agent-ip" value="127.0.0.1:9999">
                    </div>
                    <button id="btn-add-agent">Connect to Agent</button>
                </div>

                <div class="control-section">
                    <h3>CREATE NEW RENDER JOB</h3>
                    <div class="form-group">
                        <label for="job-json-path">Job JSON Path</label>
                        <input type="text" id="job-json-path" placeholder="C:\Path\To\Job.json">
                    </div>
                    <div class="form-group">
                        <label for="assign-agent-select">Assign to Agent</label>
                        <select id="assign-agent-select">
                            <option value="">-- No Idle Agents --</option>
                        </select>
                    </div>
                    <button id="btn-submit-job">Submit Job</button>
                </div>
            </div>
        </div>

        <div class="panel" id="status-panel">
            <h2>Render Farm Status</h2>
            <div id="agent-status-container">
                </div>
        </div>

        <div class="panel" id="log-panel">
            <h2>Log Output</h2>
            <div id="log-output" class="log-box"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script>
        const socket = io();

        // --- UI Elements ---
        const addAgentBtn = document.getElementById('btn-add-agent');
        const submitJobBtn = document.getElementById('btn-submit-job');
        const agentIpInput = document.getElementById('agent-ip');
        const jobPathInput = document.getElementById('job-json-path');
        const agentSelect = document.getElementById('assign-agent-select');
        const logOutput = document.getElementById('log-output');
        const agentStatusContainer = document.getElementById('agent-status-container');

        // --- Event Listeners ---
        addAgentBtn.addEventListener('click', () => {
            const ip = agentIpInput.value;
            if (ip) {
                socket.emit('add_agent', { ip: ip });
            }
        });

        submitJobBtn.addEventListener('click', () => {
            const agentId = agentSelect.value;
            const jobPath = jobPathInput.value;
            if (agentId && jobPath) {
                socket.emit('submit_job', { agent_id: agentId, job_path: jobPath });
            } else {
                addLogMessage('Error: Must select an idle agent and specify a job path.');
            }
        });


        // --- Socket.IO Event Handlers ---
        socket.on('connect', () => {
            addLogMessage('Successfully connected to Director backend.');
        });

        socket.on('log_message', (data) => {
            addLogMessage(data.message);
        });

        socket.on('agent_update', (data) => {
            updateAgentStatus(data);
            updateAgentDropdown(data.all_agents);
        });
        
        socket.on('disconnect_agent', (data) => {
             const agentCard = document.getElementById(`agent-card-${data.agent_id}`);
             if (agentCard) {
                agentCard.remove();
             }
             // We need to refetch the full agent list to update the dropdown
             socket.emit('request_agent_list_update');
        });
        
        socket.on('update_agent_dropdown', (data) => {
            updateAgentDropdown(data.all_agents);
        });


        // --- UI Update Functions ---
        function addLogMessage(message) {
            const time = new Date().toLocaleTimeString();
            logOutput.innerHTML += `<div>[${time}] ${message}</div>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function updateAgentDropdown(agents) {
            agentSelect.innerHTML = '';
            let idleAgentFound = false;
            for (const agentId in agents) {
                const agent = agents[agentId];
                if (agent.status === 'Idle') {
                    const option = document.createElement('option');
                    option.value = agentId;
                    option.textContent = `${agentId} (Idle)`;
                    agentSelect.appendChild(option);
                    idleAgentFound = true;
                }
            }
            if (!idleAgentFound) {
                agentSelect.innerHTML = '<option value="">-- No Idle Agents --</option>';
            }
        }

        function updateAgentStatus(agentData) {
            const agentId = agentData.agent_id;
            let agentCard = document.getElementById(`agent-card-${agentId}`);

            if (!agentCard) {
                agentCard = document.createElement('div');
                agentCard.className = 'agent-card';
                agentCard.id = `agent-card-${agentId}`;
                agentStatusContainer.appendChild(agentCard);
            }
            
            const status = agentData.status || 'Connecting...';
            const progress = agentData.progress || 0;
            const jobId = agentData.job_id || 'N/A';
            const frame = agentData.current_frame || 0;

            agentCard.className = `agent-card status-${status.toLowerCase()}`;

            let progressHtml = '';
            if (status === 'Rendering') {
                progressHtml = `
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${progress * 100}%"></div>
                    </div>
                    <div>${(progress * 100).toFixed(1)}% (Frame: ${frame})</div>
                `;
            }

            agentCard.innerHTML = `
                <h3>AGENT: ${agentId}</h3>
                <div class="status-line"><strong>Status:</strong> <span class="status-text">${status}</span></div>
                <div class="status-line"><strong>Current Job:</strong> ${jobId}</div>
                ${progressHtml}
            `;
        }

    </script>
</body>
</html>
